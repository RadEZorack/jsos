#!/usr/bin/env bash
set -e

echo "ğŸš€ Installing J'SOS + Sky98 Desktop Environment..."

echo "ğŸ” Stopping any running Jâ€™SOS processes..."
sudo pkill -f jsos-launcher 2>/dev/null || true
sudo pkill -f jsos-session 2>/dev/null || true

ROOT="$(dirname "$0")/.."

# ---------------------------------------------------------------------
# 1. Install directories for your JSOS environment
# ---------------------------------------------------------------------
sudo mkdir -p /usr/local/share/jsos-shell
sudo mkdir -p /usr/local/share/jsos-wm

echo "ğŸ“ Copying Web Shell..."
sudo cp -r "$ROOT/jsos-shell/"* /usr/local/share/jsos-shell/

echo "ğŸ“ Copying Sway config + Session script..."
sudo cp "$ROOT/jsos-wm/sway-config" /usr/local/share/jsos-wm/sway-config
sudo cp "$ROOT/jsos-wm/jsos-session" /usr/local/bin/jsos-session
sudo chmod +x /usr/local/bin/jsos-session

# ---------------------------------------------------------------------
# 2. Install Rust-native launcher
# ---------------------------------------------------------------------
echo "ğŸ¦€ Installing Rust launcher..."
if [ -f "$ROOT/jsos-launcher/target/release/jsos-launcher" ]; then
    sudo cp "$ROOT/jsos-launcher/target/release/jsos-launcher" /usr/local/bin/jsos-launcher
    sudo chmod +x /usr/local/bin/jsos-launcher
    echo "âœ… Installed native Rust launcher."
else
    echo "âŒ Rust launcher not found!"
    echo "Please build it first:"
    echo "  cd jsos-launcher && cargo build --release"
    exit 1
fi

# ---------------------------------------------------------------------
# 3. Install Wayland session entry
# ---------------------------------------------------------------------
echo "ğŸ–¥ï¸ Registering Jâ€™SOS Wayland session..."
sudo mkdir -p /usr/share/wayland-sessions
sudo cp "$ROOT/jsos-wm/jsos.desktop" /usr/share/wayland-sessions/jsos.desktop

# ---------------------------------------------------------------------
# SKY98 UPGRADE LAYER BEGINS HERE
# ---------------------------------------------------------------------

USER_NAME="${SUDO_USER:-$USER}"

echo "ğŸŒ¤ï¸ Installing Sky98 Extensions..."

# ---------------------------------------------------------------------
# 4. Make Jâ€™SOS default session in .dmrc
# ---------------------------------------------------------------------
echo "âš™ï¸ Setting Jâ€™SOS as default desktop session..."
sudo -u "$USER_NAME" bash -c "echo '[Desktop]' > ~/.dmrc"
sudo -u "$USER_NAME" bash -c "echo 'Session=jsos' >> ~/.dmrc"

# ---------------------------------------------------------------------
# 5. Enable auto-login (optional, but core to Sky98 feel)
# ---------------------------------------------------------------------
echo "ğŸ”“ Enabling auto-login (GDM)..."
sudo bash -c "cat > /etc/gdm3/custom.conf" <<EOF
[daemon]
AutomaticLogin=${USER_NAME}
AutomaticLoginEnable=true
EOF

# ---------------------------------------------------------------------
# 6. Replace login greeter with Sky98 styling
# ---------------------------------------------------------------------
echo "ğŸ¨ Installing Sky98 login theme..."

THEME_DIR="/usr/share/gnome-shell/theme/Yaru"
THEME_FILE="$THEME_DIR/gnome-shell.css"

# Backup once
if [ ! -f "${THEME_FILE}.backup" ]; then
    echo "ğŸ“¦ Backing up original Yaru theme..."
    sudo cp "$THEME_FILE" "${THEME_FILE}.backup"
fi

echo "âœ¨ Applying Sky98 greeter.css to $THEME_FILE"
sudo cp "$ROOT/assets/greeter.css" "$THEME_FILE"

# Wallpaper override (if needed â€” sometimes GDM loads a different key)
sudo cp "$ROOT/assets/wallpaper.png" /usr/share/backgrounds/jsos_wallpaper.png
sudo sed -i 's|#lockDialogGroup {.*|#lockDialogGroup { background: url("/usr/share/backgrounds/jsos_wallpaper.png") !important; background-size: cover !important; }|g' "$THEME_FILE"

# ---------------------------------------------------------------------
# 7. Install Plymouth boot splash for Sky98
# ---------------------------------------------------------------------
echo "ğŸŒ… Installing Sky98 boot splash..."

sudo cp -r "$ROOT/assets/plymouth/sky98" /usr/share/plymouth/themes/

sudo update-alternatives \
    --install /usr/share/plymouth/themes/default.plymouth default.plymouth \
    /usr/share/plymouth/themes/sky98/sky98.plymouth 100

sudo update-alternatives \
    --set default.plymouth /usr/share/plymouth/themes/sky98/sky98.plymouth

sudo update-initramfs -u

# ---------------------------------------------------------------------
# 8. Startup sound (boot chime)
# ---------------------------------------------------------------------
echo "ğŸ”Š Installing Sky98 boot chime audio..."
sudo mkdir -p /usr/share/jsos/sounds
sudo cp "$ROOT/assets/sound/boot_chime.wav" /usr/share/jsos/sounds/

sudo bash -c "cat > /usr/local/bin/jsos-bootsound" <<'EOF'
#!/bin/bash
aplay /usr/share/jsos/sounds/boot_chime.wav 2>/dev/null &
EOF
sudo chmod +x /usr/local/bin/jsos-bootsound

# Add to sway config (non-destructive append)
if ! grep -q "jsos-bootsound" /usr/local/share/jsos-wm/sway-config; then
    echo "exec_always /usr/local/bin/jsos-bootsound" | sudo tee -a /usr/local/share/jsos-wm/sway-config >/dev/null
fi

# ---------------------------------------------------------------------
# 9. Install compiled Dashboard (Next.js export)
# ---------------------------------------------------------------------
echo "ğŸ“¦ Installing Jâ€™SOS Sky98 Dashboard UI..."
sudo mkdir -p /usr/share/jsos/dashboard
sudo cp -r "$ROOT/jsos-dashboard/out/"* /usr/share/jsos/dashboard/

# ---------------------------------------------------------------------
# DONE
# ---------------------------------------------------------------------
echo "ğŸ‰ Sky98 Desktop + Jâ€™SOS installed!"
echo "â¡ï¸  Reboot to enter Jâ€™SOS automatically."
